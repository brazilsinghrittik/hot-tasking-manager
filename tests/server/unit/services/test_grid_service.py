import unittest
import json
import geojson
from server.services.grid_service import GridService


class TestGridService(unittest.TestCase):
    def test_trim_tasks_to_aoi(self):
        # arrange
        aoi = {
            "type": "Feature",
            "geometry": {
                "type": "MultiPolygon",
                "coordinates": [
                    [
                        [
                            [14.399299621582024, 27.053419871755366],
                            [14.432258605957022, 27.060146331991774],
                            [14.450798034667958, 27.02314581067661],
                            [14.416809082031243, 27.01702884768052],
                            [14.399299621582024, 27.053419871755366]
                        ]
                    ]
                ]
            },
            "properties": None
        }
        tasks = {
            "type": "FeatureCollection",
            "features": [
                {
                    "type": "Feature",
                    "geometry": {
                        "type": "MultiPolygon",
                        "coordinates": [
                            [
                                [
                                    [
                                        11.453247068260938,
                                        24.61456036067679
                                    ],
                                    [
                                        11.453247068260938,
                                        24.617057336671365
                                    ],
                                    [
                                        11.455993650291683,
                                        24.617057336671365
                                    ],
                                    [
                                        11.455993650291683,
                                        24.61456036067679
                                    ],
                                    [
                                        11.453247068260938,
                                        24.61456036067679
                                    ]
                                ]
                            ]
                        ]
                    },
                    "properties": {
                        "x": 69706,
                        "y": 74787,
                        "zoom": 17
                    }
                },
                {
                    "type": "Feature",
                    "geometry": {
                        "type": "MultiPolygon",
                        "coordinates": [
                            [
                                [
                                    [
                                        11.453247068260938,
                                        24.617057336671365
                                    ],
                                    [
                                        11.453247068260938,
                                        24.619554262806403
                                    ],
                                    [
                                        11.455993650291683,
                                        24.619554262806403
                                    ],
                                    [
                                        11.455993650291683,
                                        24.617057336671365
                                    ],
                                    [
                                        11.453247068260938,
                                        24.617057336671365
                                    ]
                                ]
                            ]
                        ]
                    },
                    "properties": {
                        "x": 69706,
                        "y": 74788,
                        "zoom": 17
                    }
                },
                {
                    "type": "Feature",
                    "geometry": {
                        "type": "MultiPolygon",
                        "coordinates": [
                            [
                                [
                                    [
                                        11.453247068260938,
                                        24.619554262806403
                                    ],
                                    [
                                        11.453247068260938,
                                        24.622051139078053
                                    ],
                                    [
                                        11.455993650291683,
                                        24.622051139078053
                                    ],
                                    [
                                        11.455993650291683,
                                        24.619554262806403
                                    ],
                                    [
                                        11.453247068260938,
                                        24.619554262806403
                                    ]
                                ]
                            ]
                        ]
                    },
                    "properties": {
                        "x": 69706,
                        "y": 74789,
                        "zoom": 17
                    }
                },
                {
                    "type": "Feature",
                    "geometry": {
                        "type": "MultiPolygon",
                        "coordinates": [
                            [
                                [
                                    [
                                        11.455993650291683,
                                        24.61456036067679
                                    ],
                                    [
                                        11.455993650291683,
                                        24.617057336671365
                                    ],
                                    [
                                        11.45874023232243,
                                        24.617057336671365
                                    ],
                                    [
                                        11.45874023232243,
                                        24.61456036067679
                                    ],
                                    [
                                        11.455993650291683,
                                        24.61456036067679
                                    ]
                                ]
                            ]
                        ]
                    },
                    "properties": {
                        "x": 69707,
                        "y": 74787,
                        "zoom": 17
                    }
                },
                {
                    "type": "Feature",
                    "geometry": {
                        "type": "MultiPolygon",
                        "coordinates": [
                            [
                                [
                                    [
                                        11.455993650291683,
                                        24.617057336671365
                                    ],
                                    [
                                        11.455993650291683,
                                        24.619554262806403
                                    ],
                                    [
                                        11.45874023232243,
                                        24.619554262806403
                                    ],
                                    [
                                        11.45874023232243,
                                        24.617057336671365
                                    ],
                                    [
                                        11.455993650291683,
                                        24.617057336671365
                                    ]
                                ]
                            ]
                        ]
                    },
                    "properties": {
                        "x": 69707,
                        "y": 74788,
                        "zoom": 17
                    }
                },
                {
                    "type": "Feature",
                    "geometry": {
                        "type": "MultiPolygon",
                        "coordinates": [
                            [
                                [
                                    [
                                        11.455993650291683,
                                        24.619554262806403
                                    ],
                                    [
                                        11.455993650291683,
                                        24.622051139078053
                                    ],
                                    [
                                        11.45874023232243,
                                        24.622051139078053
                                    ],
                                    [
                                        11.45874023232243,
                                        24.619554262806403
                                    ],
                                    [
                                        11.455993650291683,
                                        24.619554262806403
                                    ]
                                ]
                            ]
                        ]
                    },
                    "properties": {
                        "x": 69707,
                        "y": 74789,
                        "zoom": 17
                    }
                },
                {
                    "type": "Feature",
                    "geometry": {
                        "type": "MultiPolygon",
                        "coordinates": [
                            [
                                [
                                    [
                                        11.45874023232243,
                                        24.61456036067679
                                    ],
                                    [
                                        11.45874023232243,
                                        24.617057336671365
                                    ],
                                    [
                                        11.461486814353208,
                                        24.617057336671365
                                    ],
                                    [
                                        11.461486814353208,
                                        24.61456036067679
                                    ],
                                    [
                                        11.45874023232243,
                                        24.61456036067679
                                    ]
                                ]
                            ]
                        ]
                    },
                    "properties": {
                        "x": 69708,
                        "y": 74787,
                        "zoom": 17
                    }
                },
                {
                    "type": "Feature",
                    "geometry": {
                        "type": "MultiPolygon",
                        "coordinates": [
                            [
                                [
                                    [
                                        11.45874023232243,
                                        24.617057336671365
                                    ],
                                    [
                                        11.45874023232243,
                                        24.619554262806403
                                    ],
                                    [
                                        11.461486814353208,
                                        24.619554262806403
                                    ],
                                    [
                                        11.461486814353208,
                                        24.617057336671365
                                    ],
                                    [
                                        11.45874023232243,
                                        24.617057336671365
                                    ]
                                ]
                            ]
                        ]
                    },
                    "properties": {
                        "x": 69708,
                        "y": 74788,
                        "zoom": 17
                    }
                },
                {
                    "type": "Feature",
                    "geometry": {
                        "type": "MultiPolygon",
                        "coordinates": [
                            [
                                [
                                    [
                                        11.45874023232243,
                                        24.619554262806403
                                    ],
                                    [
                                        11.45874023232243,
                                        24.622051139078053
                                    ],
                                    [
                                        11.461486814353208,
                                        24.622051139078053
                                    ],
                                    [
                                        11.461486814353208,
                                        24.619554262806403
                                    ],
                                    [
                                        11.45874023232243,
                                        24.619554262806403
                                    ]
                                ]
                            ]
                        ]
                    },
                    "properties": {
                        "x": 69708,
                        "y": 74789,
                        "zoom": 17
                    }
                },
                {
                    "type": "Feature",
                    "geometry": {
                        "type": "MultiPolygon",
                        "coordinates": [
                            [
                                [
                                    [
                                        11.461486814353208,
                                        24.61456036067679
                                    ],
                                    [
                                        11.461486814353208,
                                        24.617057336671365
                                    ],
                                    [
                                        11.464233396383955,
                                        24.617057336671365
                                    ],
                                    [
                                        11.464233396383955,
                                        24.61456036067679
                                    ],
                                    [
                                        11.461486814353208,
                                        24.61456036067679
                                    ]
                                ]
                            ]
                        ]
                    },
                    "properties": {
                        "x": 69709,
                        "y": 74787,
                        "zoom": 17
                    }
                },
                {
                    "type": "Feature",
                    "geometry": {
                        "type": "MultiPolygon",
                        "coordinates": [
                            [
                                [
                                    [
                                        11.461486814353208,
                                        24.617057336671365
                                    ],
                                    [
                                        11.461486814353208,
                                        24.619554262806403
                                    ],
                                    [
                                        11.464233396383955,
                                        24.619554262806403
                                    ],
                                    [
                                        11.464233396383955,
                                        24.617057336671365
                                    ],
                                    [
                                        11.461486814353208,
                                        24.617057336671365
                                    ]
                                ]
                            ]
                        ]
                    },
                    "properties": {
                        "x": 69709,
                        "y": 74788,
                        "zoom": 17
                    }
                },
                {
                    "type": "Feature",
                    "geometry": {
                        "type": "MultiPolygon",
                        "coordinates": [
                            [
                                [
                                    [
                                        11.461486814353208,
                                        24.619554262806403
                                    ],
                                    [
                                        11.461486814353208,
                                        24.622051139078053
                                    ],
                                    [
                                        11.464233396383955,
                                        24.622051139078053
                                    ],
                                    [
                                        11.464233396383955,
                                        24.619554262806403
                                    ],
                                    [
                                        11.461486814353208,
                                        24.619554262806403
                                    ]
                                ]
                            ]
                        ]
                    },
                    "properties": {
                        "x": 69709,
                        "y": 74789,
                        "zoom": 17
                    }
                }
            ]
        }
        expected_tasks = tasks

        # act
        trimmed_tasks = GridService.trim_tasks_to_aoi(aoi, tasks, True)

        # assert
        self.assertEquals(trimmed_tasks, expected_tasks)
