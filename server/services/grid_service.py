import json
import geojson
from geoalchemy2 import functions
from shapely.geometry import shape
from shapely.prepared import prep


class GridService:

    @staticmethod
    def trim_tasks_to_aoi(tasks, aoi, clip):
        return tasks

    @staticmethod
    def geometries_intersect(task, aoi) -> bool:
        p = prep(aoi)
        intersects = p.intersects(task)
        return intersects

    @staticmethod
    def find_intersecting_tasks(tasks, aoi):
        tasks = {
            "type": "FeatureCollection",
            "features": [
                {
                    "type": "Feature",
                    "geometry": {
                        "type": "MultiPolygon",
                        "coordinates": [
                            [
                                [
                                    [
                                        11.453247068260938,
                                        24.61456036067679
                                    ],
                                    [
                                        11.453247068260938,
                                        24.617057336671365
                                    ],
                                    [
                                        11.455993650291683,
                                        24.617057336671365
                                    ],
                                    [
                                        11.455993650291683,
                                        24.61456036067679
                                    ],
                                    [
                                        11.453247068260938,
                                        24.61456036067679
                                    ]
                                ]
                            ]
                        ]
                    },
                    "properties": {
                        "x": 69706,
                        "y": 74787,
                        "zoom": 17
                    }
                },
                {
                    "type": "Feature",
                    "geometry": {
                        "type": "MultiPolygon",
                        "coordinates": [
                            [
                                [
                                    [
                                        11.453247068260938,
                                        24.617057336671365
                                    ],
                                    [
                                        11.453247068260938,
                                        24.619554262806403
                                    ],
                                    [
                                        11.455993650291683,
                                        24.619554262806403
                                    ],
                                    [
                                        11.455993650291683,
                                        24.617057336671365
                                    ],
                                    [
                                        11.453247068260938,
                                        24.617057336671365
                                    ]
                                ]
                            ]
                        ]
                    },
                    "properties": {
                        "x": 69706,
                        "y": 74788,
                        "zoom": 17
                    }
                },
                {
                    "type": "Feature",
                    "geometry": {
                        "type": "MultiPolygon",
                        "coordinates": [
                            [
                                [
                                    [
                                        11.453247068260938,
                                        24.619554262806403
                                    ],
                                    [
                                        11.453247068260938,
                                        24.622051139078053
                                    ],
                                    [
                                        11.455993650291683,
                                        24.622051139078053
                                    ],
                                    [
                                        11.455993650291683,
                                        24.619554262806403
                                    ],
                                    [
                                        11.453247068260938,
                                        24.619554262806403
                                    ]
                                ]
                            ]
                        ]
                    },
                    "properties": {
                        "x": 69706,
                        "y": 74789,
                        "zoom": 17
                    }
                },
                {
                    "type": "Feature",
                    "geometry": {
                        "type": "MultiPolygon",
                        "coordinates": [
                            [
                                [
                                    [
                                        11.455993650291683,
                                        24.61456036067679
                                    ],
                                    [
                                        11.455993650291683,
                                        24.617057336671365
                                    ],
                                    [
                                        11.45874023232243,
                                        24.617057336671365
                                    ],
                                    [
                                        11.45874023232243,
                                        24.61456036067679
                                    ],
                                    [
                                        11.455993650291683,
                                        24.61456036067679
                                    ]
                                ]
                            ]
                        ]
                    },
                    "properties": {
                        "x": 69707,
                        "y": 74787,
                        "zoom": 17
                    }
                },
                {
                    "type": "Feature",
                    "geometry": {
                        "type": "MultiPolygon",
                        "coordinates": [
                            [
                                [
                                    [
                                        11.455993650291683,
                                        24.617057336671365
                                    ],
                                    [
                                        11.455993650291683,
                                        24.619554262806403
                                    ],
                                    [
                                        11.45874023232243,
                                        24.619554262806403
                                    ],
                                    [
                                        11.45874023232243,
                                        24.617057336671365
                                    ],
                                    [
                                        11.455993650291683,
                                        24.617057336671365
                                    ]
                                ]
                            ]
                        ]
                    },
                    "properties": {
                        "x": 69707,
                        "y": 74788,
                        "zoom": 17
                    }
                },
                {
                    "type": "Feature",
                    "geometry": {
                        "type": "MultiPolygon",
                        "coordinates": [
                            [
                                [
                                    [
                                        11.455993650291683,
                                        24.619554262806403
                                    ],
                                    [
                                        11.455993650291683,
                                        24.622051139078053
                                    ],
                                    [
                                        11.45874023232243,
                                        24.622051139078053
                                    ],
                                    [
                                        11.45874023232243,
                                        24.619554262806403
                                    ],
                                    [
                                        11.455993650291683,
                                        24.619554262806403
                                    ]
                                ]
                            ]
                        ]
                    },
                    "properties": {
                        "x": 69707,
                        "y": 74789,
                        "zoom": 17
                    }
                },
                {
                    "type": "Feature",
                    "geometry": {
                        "type": "MultiPolygon",
                        "coordinates": [
                            [
                                [
                                    [
                                        11.45874023232243,
                                        24.61456036067679
                                    ],
                                    [
                                        11.45874023232243,
                                        24.617057336671365
                                    ],
                                    [
                                        11.461486814353208,
                                        24.617057336671365
                                    ],
                                    [
                                        11.461486814353208,
                                        24.61456036067679
                                    ],
                                    [
                                        11.45874023232243,
                                        24.61456036067679
                                    ]
                                ]
                            ]
                        ]
                    },
                    "properties": {
                        "x": 69708,
                        "y": 74787,
                        "zoom": 17
                    }
                },
                {
                    "type": "Feature",
                    "geometry": {
                        "type": "MultiPolygon",
                        "coordinates": [
                            [
                                [
                                    [
                                        11.45874023232243,
                                        24.617057336671365
                                    ],
                                    [
                                        11.45874023232243,
                                        24.619554262806403
                                    ],
                                    [
                                        11.461486814353208,
                                        24.619554262806403
                                    ],
                                    [
                                        11.461486814353208,
                                        24.617057336671365
                                    ],
                                    [
                                        11.45874023232243,
                                        24.617057336671365
                                    ]
                                ]
                            ]
                        ]
                    },
                    "properties": {
                        "x": 69708,
                        "y": 74788,
                        "zoom": 17
                    }
                },
                {
                    "type": "Feature",
                    "geometry": {
                        "type": "MultiPolygon",
                        "coordinates": [
                            [
                                [
                                    [
                                        11.45874023232243,
                                        24.619554262806403
                                    ],
                                    [
                                        11.45874023232243,
                                        24.622051139078053
                                    ],
                                    [
                                        11.461486814353208,
                                        24.622051139078053
                                    ],
                                    [
                                        11.461486814353208,
                                        24.619554262806403
                                    ],
                                    [
                                        11.45874023232243,
                                        24.619554262806403
                                    ]
                                ]
                            ]
                        ]
                    },
                    "properties": {
                        "x": 69708,
                        "y": 74789,
                        "zoom": 17
                    }
                },
                {
                    "type": "Feature",
                    "geometry": {
                        "type": "MultiPolygon",
                        "coordinates": [
                            [
                                [
                                    [
                                        11.461486814353208,
                                        24.61456036067679
                                    ],
                                    [
                                        11.461486814353208,
                                        24.617057336671365
                                    ],
                                    [
                                        11.464233396383955,
                                        24.617057336671365
                                    ],
                                    [
                                        11.464233396383955,
                                        24.61456036067679
                                    ],
                                    [
                                        11.461486814353208,
                                        24.61456036067679
                                    ]
                                ]
                            ]
                        ]
                    },
                    "properties": {
                        "x": 69709,
                        "y": 74787,
                        "zoom": 17
                    }
                },
                {
                    "type": "Feature",
                    "geometry": {
                        "type": "MultiPolygon",
                        "coordinates": [
                            [
                                [
                                    [
                                        11.461486814353208,
                                        24.617057336671365
                                    ],
                                    [
                                        11.461486814353208,
                                        24.619554262806403
                                    ],
                                    [
                                        11.464233396383955,
                                        24.619554262806403
                                    ],
                                    [
                                        11.464233396383955,
                                        24.617057336671365
                                    ],
                                    [
                                        11.461486814353208,
                                        24.617057336671365
                                    ]
                                ]
                            ]
                        ]
                    },
                    "properties": {
                        "x": 69709,
                        "y": 74788,
                        "zoom": 17
                    }
                },
                {
                    "type": "Feature",
                    "geometry": {
                        "type": "MultiPolygon",
                        "coordinates": [
                            [
                                [
                                    [
                                        11.461486814353208,
                                        24.619554262806403
                                    ],
                                    [
                                        11.461486814353208,
                                        24.622051139078053
                                    ],
                                    [
                                        11.464233396383955,
                                        24.622051139078053
                                    ],
                                    [
                                        11.464233396383955,
                                        24.619554262806403
                                    ],
                                    [
                                        11.461486814353208,
                                        24.619554262806403
                                    ]
                                ]
                            ]
                        ]
                    },
                    "properties": {
                        "x": 69709,
                        "y": 74789,
                        "zoom": 17
                    }
                }
            ]
        }
        aoi_polygon = shape(aoi)
        intersecting_features = []
        for task_feature in tasks['features']:
            task = shape(task_feature['geometry'])
            if(GridService.geometries_intersect(task, aoi_polygon)):
                intersecting_features.append(task_feature)

        return geojson.FeatureCollection(intersecting_features)
