{
  "description": "Packer template for tasking-manager host instance. Ubuntu 16.04; us-east-1; t2.micro",
  "variables": {
    "aws_access_key": "{{env `AWS_ACCESS_KEY_ID`}}",
    "aws_secret_key": "{{env `AWS_SECRET_ACCESS_KEY`}}",
    "instance_type": "t2.micro",
    "instance_region": "us-east-1",
    "ssh_username": "ubuntu",
    "created_by": "{{env `PACKER_RUN_OWNER`}}",
    "name": "tasking-manager-{{timestamp}}"
  },
  "builders": [{
    "access_key": "{{user `aws_access_key`}}",
    "secret_key": "{{user `aws_secret_key`}}",

    "type": "amazon-ebs",
    "region": "{{user `instance_region`}}",
    "instance_type": "{{user `instance_type`}}",
    "ssh_username": "{{user `ssh_username`}}",
    "ami_name": "{{user `name`}}",
    "source_ami_filter": {
      "filters": {
        "virtualization-type": "hvm",
        "name": "ubuntu/images/*ubuntu-xenial-16.04-amd64-server-*",
        "root-device-type": "ebs"
      },
      "owners": ["099720109477"],
      "most_recent": true
    },
    "tags": {
      "component": "tasking_manager",
      "built_by": "packer",
      "created_by": "{{user `created_by`}}",
      "Name": "{{user `name`}}"
    }
  }],
  "provisioners": [{
    "type": "shell",
    "inline_shebang": "/bin/bash -e",
    "inline": [
      "export DEBIAN_FRONTEND=noninteractive",
      "export LC_ALL=\"en_US.UTF-8\"",
      "export LC_CTYPE=\"en_US.UTF-8\"",
      "export LC_ALL=C",
      "sudo dpkg-reconfigure --frontend=noninteractive locales",
      "sudo apt-get -y update",
      "sudo DEBIAN_FRONTEND=noninteractive apt-get -y -o Dpkg::Options::=\"--force-confdef\" -o Dpkg::Options::=\"--force-confold\" dist-upgrade",
      "sudo add-apt-repository ppa:jonathonf/python-3.6 -y",
      "sudo apt-get -y update",
      "sudo apt-get -y install awscli curl git ruby unzip wget",
      "sudo apt-get -y install python3.6 python3.6-dev python3.6-venv python-pip",
      "sudo apt-get -y install libgdal1-dev libgeos-3.5.0 libgeos-dev libproj9 libproj-dev libxml2 libxml2-dev libjson-c-dev",
      "sudo apt-get -y install postgresql-9.5 libpq-dev postgresql-server-dev-9.5",
      "echo \"Installing kpartx, grub as required by ec2-ami-tools\"",
      "sudo apt-get -y install kpartx grub",
      "curl -sL https://deb.nodesource.com/setup_9.x | sudo -E bash -",
      "sudo apt-get -y install nodejs",
      "sudo npm install gulp -g",
      "npm install browser-sync --save",
      "sudo git clone --recursive https://github.com/hotosm/tasking-manager.git /tasking-manager",
      "echo fs.inotify.max_user_watches=524288 | sudo tee -a /etc/sysctl.conf",
      "wget https://s3.amazonaws.com/cloudformation-examples/aws-cfn-bootstrap-latest.tar.gz",
      "pip2 install aws-cfn-bootstrap-latest.tar.gz",
      "wget https://s3.amazonaws.com/ec2-downloads/ec2-ami-tools.zip",
      "sudo mkdir -p /usr/local/ec2",
      "sudo unzip -qq ec2-ami-tools.zip -d /usr/local/ec2",
      "echo \"Create /etc/profile.d/myenvvars.sh\"",
      "sudo touch /etc/profile.d/myenvvars.sh",
      "echo \"add to etc/profile.d/myenvvars.sh export variable EC2_AMITOOL_HOME\"",
      "sudo bash -c 'echo \"export EC2_AMITOOL_HOME=/usr/local/ec2/ec2-ami-tools-1.5.7\" >> /etc/profile.d/myenvvars.sh'",
      "sudo bash -c 'echo \"export PATH=/usr/local/ec2/ec2-ami-tools-1.5.7/bin:$PATH:\" >> /etc/profile.d/myenvvars.sh'"
    ]
  }]
}
