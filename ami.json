{
  "variables": {
    "aws_access_key": "{{env `AWS_ACCESS_KEY_ID`}}",
    "aws_secret_key": "{{env `AWS_SECRET_ACCESS_KEY`}}"
  },
  "builders": [{
    "type": "amazon-ebs",
    "access_key": "{{user `aws_access_key`}}",
    "secret_key": "{{user `aws_secret_key`}}",
    "region": "us-east-1",
    "instance_type": "t2.micro",
    "ssh_username": "ubuntu",
    "ami_name": "tasking-manager-{{timestamp}}",
    "source_ami": "ami-04910d30961dda246"
  }],
  "provisioners": [{
    "type": "shell",
    "inline": [
      "export DEBIAN_FRONTEND=noninteractive",
      "export LC_ALL=\"en_US.UTF-8\"",
      "export LC_CTYPE=\"en_US.UTF-8\"",
      "sudo dpkg-reconfigure --frontend=noninteractive locales",
      "sudo apt-get -y update",
      "sudo DEBIAN_FRONTEND=noninteractive apt-get -y -o Dpkg::Options::=\"--force-confdef\" -o Dpkg::Options::=\"--force-confold\" dist-upgrade",
      "sudo add-apt-repository ppa:jonathonf/python-3.6 -y",
      "sudo apt-get -y update",
      "sudo apt-get -y install python3.6",
      "sudo apt-get -y install python3.6-dev",
      "sudo apt-get -y install python3.6-venv",
      "sudo apt-get -y install curl",
      "curl -sL https://deb.nodesource.com/setup_6.x > install-node6.sh",
      "sudo chmod +x install-node6.sh",
      "sudo ./install-node6.sh",
      "sudo apt-get -y install nodejs",
      "sudo npm install gulp -g",
      "npm i browser-sync --save",
      "sudo apt-get -y install postgresql-9.5",
      "sudo apt-get -y install libpq-dev",
      "sudo apt-get -y install postgresql-server-dev-9.5",
      "sudo apt-get -y install libxml2",
      "sudo apt-get -y install wget libxml2-dev",
      "sudo apt-get -y install libgeos-3.5.0",
      "sudo apt-get -y install libgeos-dev",
      "sudo apt-get -y install libproj9",
      "sudo apt-get -y install libproj-dev",
      "sudo apt-get -y install python-pip libgdal1-dev",
      "sudo apt-get -y install libjson-c-dev",
      "sudo apt-get -y install git",
      "sudo apt-get -y install awscli",
      "sudo git clone --recursive https://github.com/hotosm/tasking-manager.git /tasking-manager",
      "echo fs.inotify.max_user_watches=524288 | sudo tee -a /etc/sysctl.conf",
      "export LC_ALL=C",
      "wget https://s3.amazonaws.com/cloudformation-examples/aws-cfn-bootstrap-latest.tar.gz",
      "pip2 install aws-cfn-bootstrap-latest.tar.gz",
      "echo \"apt-get commands\"",
      "sudo apt-get update -y && sudo apt-get install -y ruby unzip",
      "echo \"wget for ec2 ami tools\"",
      "wget https://s3.amazonaws.com/ec2-downloads/ec2-ami-tools.zip",
      "echo \"make directory\"",
      "sudo mkdir -p /usr/local/ec2",
      "echo \"unzip tools\"",
      "sudo unzip ec2-ami-tools.zip -d /usr/local/ec2",
      "echo \"Create /etc/profile.d/myenvvars.sh\"",
      "sudo touch /etc/profile.d/myenvvars.sh",
      "echo \"Installing kpartx, grub as required by ec2-ami-tools\"",
      "sudo apt-get install kpartx -y",
      "sudo apt-get install grub -y",
      "echo \"add to etc/profile.d/myenvvars.sh export variable EC2_AMITOOL_HOME\"",
      "sudo bash -c 'echo \"export EC2_AMITOOL_HOME=/usr/local/ec2/ec2-ami-tools-1.5.7\" >> /etc/profile.d/myenvvars.sh'",
      "sudo bash -c 'echo \"export PATH=/usr/local/ec2/ec2-ami-tools-1.5.7/bin:$PATH:\" >> /etc/profile.d/myenvvars.sh'"
    ]
  }]
}
